<!DOCTYPE html>
<html>
<head>
    <title>release-tracking-with-filters-0.0.4</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Fri Dec 07 2018 21:24:15 GMT+0000 (UTC) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Fri Dec 07 2018 21:24:15 GMT+0000 (UTC)";
        var CHECKSUM = 15867579932;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Rally.ui.renderer.GridEditorFactory.editorRenderers.PreliminaryEstimate=function(a){return{xtype:"rallyrecordcontexteditor",field:{xtype:"rallycombobox",allowNoEntry:!a.required,editable:!1,name:a.name,storeConfig:{autoLoad:!0,model:a.name,remoteFilter:!0,sorters:[{property:"Value"}],listeners:{load:function(){}}}}}},Ext.define("Utils.AncestorPiInlineFilter",{override:"Rally.ui.inlinefilter.QuickFilterPanel",portfolioItemTypes:[],modelName:void 0,customFilterNamePrefix:"AncestorPiInlineFilter.",_hasPiAncestor:function(a){return _.contains(["hierarchicalrequirement","userstory","defect"],a)||a.startsWith("portfolioitem")},_pisAbove:function(a){var b=[];if(_.contains(["hierarchicalrequirement","userstory","defect"],a))b=this.portfolioItemTypes;else if(a.startsWith("portfolioitem")){var c=_.findIndex(this.portfolioItemTypes,function(b){return b.get("TypePath").toLowerCase()===a});c>=0&&c<this.portfolioItemTypes.length-1&&(b=this.portfolioItemTypes.slice(c+1))}return b},initComponent:function(){this.context||(this.context=Rally.getApp().getContext().getDataContext()),this.modelName&&(this.modelName=this.modelName.toLowerCase());var a={},b=[];if(this._hasPiAncestor(this.modelName)){var c=this._pisAbove(this.modelName);_.each(c,function(d){var e=d.get("TypePath"),f=this.customFilterNamePrefix+e,g="Portfolio Item / "+d.get("Name");a[f]={xtype:"ancestorpisearchcombobox",portfolioItemType:e,piTypesAbove:c,artifactTypeName:this.modelName,storeConfig:{context:this.context,models:e,autoLoad:!0},allowNoEntry:!0,noEntryValue:null,noEntryText:"No "+g,emptyText:"Search "+g+"s...",allowClear:!1,valueField:"ObjectUUID"},b.push({name:f,displayName:g})},this),_.merge(this.addQuickFilterConfig,{additionalFields:b},function(a,b){return _.isArray(a)?_.uniq(a.concat(b),"name"):void 0}),Ext.override(Rally.ui.inlinefilter.FilterFieldFactory,a)}this.callParent(arguments)},_createFields:function(){this.fields=_.filter(this.fields,function(a){return this._filterInvalidAncestorFilters(a)},this),this.initialFilters=_.filter(this.initialFilters,function(a){return this._filterInvalidAncestorFilters(a.name)},this),this.callParent(arguments)},_filterInvalidAncestorFilters:function(a){return!a.startsWith(this.customFilterNamePrefix)||Rally.ui.inlinefilter.FilterFieldFactory.hasOwnProperty(a)}}),Ext.define("Utils.AncestorPiSearchComboBox",{alias:"widget.ancestorpisearchcombobox",extend:"Rally.ui.combobox.ArtifactSearchComboBox",parentField:"PortfolioItem.Parent.",artifactTypeName:void 0,piTypesAbove:[],statics:{UUID_REGEX:/([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})/},initComponent:function(){this.storeConfig.filters=[],this.value&&(this.storeConfig.filters=[{property:this.valueField,value:this.value}]),this.callParent(arguments)},getFilter:function(){var a=this.lastValue,b=this.propertyPrefix(),c=[];return a&&this.statics().UUID_REGEX.test(a)?c.push({property:b+".ObjectUUID",value:a}):c.push({property:b,value:null}),Rally.data.wsapi.Filter.or(c)},propertyPrefix:function(){var a;return"hierarchicalrequirement"===this.artifactTypeName||"userstory"===this.artifactTypeName?a=this.piTypesAbove[0].get("Name"):"defect"===this.artifactTypeName?a="Requirement."+this.piTypesAbove[0].get("Name"):this.artifactTypeName.startsWith("portfolioitem")&&(a="Parent"),a&&_.forEach(this.piTypesAbove,function(b){return b.get("TypePath").toLowerCase()==this.portfolioItemType.toLowerCase()?!1:void(a+=".Parent")},this),a}}),Ext.override(Rally.ui.gridboard.SharedViewComboBox,{_isViewPreference:function(a){return"preference"===a.self.typePath&&"View"===a.get("Type")&&a.get("AppId")==this.getContext().getAppId()},getSharedViewParam:function(){var a=parent.location.hash,b=a.match(/sharedViewId=(\d+)/);return b&&b[1]},_ensureLatestView:function(a){if(a.objectId&&a.versionId){var b=Ext.create("Deft.Deferred");this.store.model.load(a.objectId,{fetch:["VersionId","Value"],success:function(a){b.resolve(a)}}),this.store.on("load",function(){b.promise.then({success:function(b){b&&b.get("VersionId")!==a.versionId&&this._applyView(this._decodeValue(b))},scope:this})},this,{single:!0})}}}),Ext.define("Constants",{statics:{FEATURE_FETCH:["FormattedID","Name","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","Project","DisplayColor"],STORIES_FETCH:["FormattedID","Name","Iteration","Project","StartDate","EndDate"],STORY_COLUMNS:["FormattedID","Name","PlanEstimate","ScheduleState"],RELEASE_CONTROL_LABEL:"Release Tracking",RELEASE_CONTROL_LABEL_CLASS:"ts-page-label",UNSCHEDULED:"Unscheduled",START_DATE:"Iterations from",END_DATE:"to",PORTFOLIO_ITEMS:"Portfolio Items"}}),Ext.define("StoryFeatureCard",{extend:"Rally.ui.cardboard.Card",alias:"widget.storyfeaturecard",hidden:!1,initComponent:function(){this.hidden=this.isHiddenFunc(this),this.callParent(arguments),this.feature=this.record.get("Feature")},setupPlugins:function(){},_getFeatureColor:function(){var a={tag:"div",cls:"ts-artifact-color"};return this.feature.DisplayColor&&(a.style={backgroundColor:this.feature.DisplayColor}),Ext.DomHelper.createHtml(a)},_buildHtml:function(){var a=[];return a.push('<div class="ts-card-table-ct"><table class="ts-card-table"><tr>'),a.push('<td class="ts-card-content">'+this._getFeatureColor()+"</td>"),a.push('<td class="ts-card-content"><div>'+this.feature.FormattedID+"</div></td>"),a.push("</tr></table>"),a.join("\n")}}),Ext.define("TsGridboardProjectScope",{alias:"plugin.tsgridboardprojectscope",extend:"Ext.AbstractPlugin",mixins:["Rally.ui.gridboard.plugin.GridBoardControlShowable"],init:function(a){this.callParent(arguments),this.cmp=a,this.showControl()},getControlCmpConfig:function(){return _.merge({xtype:"rallycombobox",id:"ignoreScopeControl",cls:"ts-scope-control",stateful:!0,stateId:this.cmp.getContext().getScopedStateId("TsGridboardProjectScope"),stateEvents:["select"],displayField:"text",valueField:"value",storeConfig:{fields:["text","value"],data:[{text:"In Current Project(s)",value:!1},{text:"In Any Project",value:!0}]}},this.controlConfig)}}),Ext.override(Rally.ui.gridboard.plugin.GridBoardFieldPicker,{gridFieldBlackList:["Changesets","Children","ObjectID","Predecessors","RevisionHistory","Subscription","Successors","TaskIndex","Workspace","VersionId"]}),Ext.override(Rally.ui.inlinefilter.PropertyFieldComboBox,{defaultWhiteListFields:["Milestones","Tags"]}),Ext.define("release-tracking-with-filters",{extend:"Rally.app.App",componentCls:"app",layout:{type:"hbox",align:"stretch"},items:[{id:"left-area",xtype:"panel",border:!1,bodyBorder:!1,header:{cls:"ts-panel-header"},cls:"grid-area",title:Constants.PORTFOLIO_ITEMS,flex:1,layout:{type:"vbox",align:"stretch"},items:[{id:"grid-area",xtype:"container",flex:1,layout:{type:"vbox",align:"stretch"}}]},{id:"right-area",xtype:"container",flex:2,type:"vbox",align:"stretch",overflowX:"auto",overflowY:"auto",padding:"0 0 0 20",items:[{id:"date-range-area",xtype:"container",layout:"hbox"},{id:"board-area",xtype:"container",flex:1,type:"vbox",align:"stretch",overflowX:"auto",overflowY:"auto"}]}],config:{defaultSettings:{},ignoreProjectScope:!1},integrationHeaders:{name:"release-tracking-with-filters"},launch:function(){var a=this.down("#date-range-area");a.add([{xtype:"rallydatefield",id:"start-date-picker",fieldLabel:Constants.START_DATE,labelWidth:100,labelCls:"date-label",margin:"0 10 0 0",listeners:{scope:this,change:function(a,b){this.timeboxStart=b,this._update()}}},{xtype:"rallydatefield",id:"end-date-picker",fieldLabel:Constants.END_DATE,labelWidth:10,labelCls:"date-label",margin:"0 10 0 0",listeners:{scope:this,change:function(a,b){this.timeboxEnd=b,this._update()}}}]);var b=this.getContext().getTimeboxScope();this._onTimeboxScopeChange(b);var c=[];c.push(Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(a){return this.portfolioItemTypes=a,this.lowestPi=this.portfolioItemTypes[0],this.lowestPiTypePath=this.lowestPi.get("TypePath"),this.lowestPiTypeName=this.lowestPi.get("Name"),this.modelNames=[this.lowestPiTypePath],Rally.data.wsapi.ModelFactory.getModel({type:this.lowestPiTypePath})}}).then({scope:this,success:function(a){this.lowestPiModel=a}})),Deft.promise.Promise.all(c).then({scope:this,success:this._update})},_update:function(){return this.setLoading(!0),this._updateIterationsStore().then({scope:this,success:function(a){return this.currentIterations=a,this._updatePisStore()}}).then({scope:this,success:function(a){this._addPisGrid(this.piStore)}})},setLoading:function(a){if(this.down("#board-area").setLoading(a),this.grid){var b=this.grid.down("rallytreegrid");b&&b.setLoading(a)}},onResize:function(){this.callParent(arguments);var a=this.down("#grid-area"),b=this.down("rallygridboard");return void(a&&b&&b.setHeight(a.getHeight()-30))},_updatePisStore:function(){return this.currentDataContext=this.getContext().getDataContext(),this.searchAllProjects()&&(this.currentDataContext.project=null),this.currentPiQueries=this._getPiQueries(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[this.lowestPiTypePath],autoLoad:!1,fetch:Constants.FEATURE_FETCH,filters:this.currentPiQueries,enableHierarchy:!0,remoteSort:!0,context:this.currentDataContext,enablePostGet:!0,enableRootLevelPostGet:!0,clearOnLoad:!1,limit:10,pageSize:10}).then({scope:this,success:function(a){this.piStore=a}})},_getPiQueries:function(){var a=[];switch(this.timeboxType){case"release":a.push({property:"Release",value:this.timebox?this.timebox.get("_ref"):null});break;case"iteration":this.timebox?(a.push({property:"UserStories.Iteration.Name",value:this.timebox.get("Name")}),a.push({property:"UserStories.Iteration.StartDate",value:this.timebox.get("StartDate")}),a.push({property:"UserStories.Iteration.EndDate",value:this.timebox.get("EndDate")})):a.push({property:"UserStories.Iteration",value:null});break;case"milestone":a.push({property:"Milestones.ObjectID",value:this.timebox?this.timebox.get("ObjectID"):null})}return a},_updateIterationsStore:function(){var a=Rally.data.wsapi.Filter.and([{property:"EndDate",operator:">=",value:this.timeboxStart},{property:"StartDate",operator:"<=",value:this.timeboxEnd}]);return this.iterationsStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!1,filters:a,context:this.getContext().getDataContext()}),this.iterationsStore.load()},_getDefects:function(){},_addPisGrid:function(a){var b=this.down("#grid-area");b&&b.removeAll();var c=this.modelNames[0],d=this.getContext().getDataContext();d.project=null,this.grid=b.add({xtype:"rallygridboard",context:this.getContext(),modelNames:this.modelNames,toggleState:"grid",height:b.getHeight()-30,listeners:{scope:this,viewchange:this.viewChange,load:function(a){this._onGridLoad(a)}},plugins:[{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:this.getModelScopedStateId(c,"filters"),modelNames:this.modelNames,inlineFilterPanelConfig:{quickFilterPanelConfig:{context:d,portfolioItemTypes:this.portfolioItemTypes,modelName:this.lowestPiTypePath,whiteListFields:["Tags","Milestones"]}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:this.modelNames,stateful:!0,stateId:this.getModelScopedStateId(c,"fields")},{ptype:"tsgridboardprojectscope",headerPosition:"left",stateful:!0,stateId:this.getModelScopedStateId(c,"fields"),controlConfig:{value:this.ignoreProjectScope,listeners:{scope:this,select:function(a,b){this.ignoreProjectScope=a.getValue(),this._update()}}}},{ptype:"rallygridboardsharedviewcontrol",sharedViewConfig:{stateful:!0,stateId:this.getModelScopedStateId(c,"views"),stateEvents:["select","beforedestroy"]}}],gridConfig:{shouldShowRowActionsColumn:!1,enableBulkEdit:!1,enableEditing:!1,enableColumnMove:!1,enableInlineAdd:!1,enableRanking:!0,store:a,storeConfig:{context:this.currentDataContext,filters:this.currentPiQueries,limit:10,pageSize:10},listeners:{scope:this,itemclick:function(a,b,c,d){b.get("_type")==this.lowestPiTypePath.toLowerCase()&&this._onPiSelected(b)}}}})},_onGridLoad:function(a){var b=a.getGridOrBoard().getStore(),c=b.getRootNode(),d=_.map(c.childNodes,function(a){return{property:this.lowestPiTypeName,operator:"=",value:a.get("_ref")}},this);this.storiesFilter=Rally.data.wsapi.Filter.or(d)||[{property:"ObjectID",value:0}];var e=this._addPisBoard(this.storiesFilter,this.currentIterations).then({scope:this,success:function(){this.setLoading(!1)}});return e},_onPiSelected:function(a){var b;this.selectedPi==a?(b=this.storiesFilter,delete this.selectedPi):(this.selectedPi=a,b=Rally.data.wsapi.Filter({property:this.lowestPiTypeName,operator:"=",value:a.get("_ref")})),this.buckets={},this.board.refresh({storeConfig:{filters:b}})},_addPisBoard:function(a,b){var c=Ext.create("Deft.Deferred"),d=this.down("#board-area");d.removeAll(),this.buckets={};var e=this.getContext(),f=(e.getDataContext(),_.sortBy(b,function(a){return a.get("EndDate")})),g=_.unique(f,function(a){return this._getIterationKey(a)},this),h=_.map(g,function(a){var b=a.get("StartDate").toLocaleDateString(),c=a.get("EndDate").toLocaleDateString(),d=new Ext.XTemplate('<div class="iteration-name">{name}</div><div class="iteration-dates">{start} - {end}</dev>').apply({name:a.get("Name"),start:b,end:c});return{xtype:"rallycardboardcolumn",columnHeaderConfig:{headerTpl:d,cls:"cardboard-column-header"},fields:["Feature"],additionalFetchFields:Constants.STORIES_FETCH,getStoreFilter:function(){return[{property:"Iteration.Name",value:a.get("Name")},{property:"Iteration.StartDate",value:a.get("StartDate")},{property:"Iteration.EndDate",value:a.get("EndDate")}]},isMatchingRecord:function(a){return!0}}},this);return h.push({xtype:"rallycardboardcolumn",value:null,columnHeaderConfig:{headerTpl:Constants.UNSCHEDULED},fields:["Feature"],additionalFetchFields:Constants.STORIES_FETCH}),this.board=d.add({xtype:"rallycardboard",type:["HierarchicalRequirement"],attribute:"Iteration",storeConfig:{filters:a,fetch:"Feature",groupField:"Feature",context:this.currentDataContext},listeners:{scope:this,boxready:function(){c.resolve()}},rowConfig:{field:"Project"},columns:h,cardConfig:{xtype:"storyfeaturecard",isHiddenFunc:this._isCardHidden.bind(this),listeners:{scope:this,select:function(a){var b=a.getRecord(),c=b.get(this.lowestPiTypeName),d=this.piStore.getById(c),e=this.getContext().getDataContext();e.project=b.get("Project")._ref;var f=b.get("Iteration"),g=[];g=f?[{property:"Iteration.Name",value:f.Name},{property:"Iteration.StartDate",value:f.StartDate},{property:"Iteration.EndDate",value:f.EndDate}]:[{property:"Iteration",value:null}],Rally.ui.popover.PopoverFactory.bake({field:"UserStory",record:d,target:a.getEl(),context:e,listViewConfig:{gridConfig:{storeConfig:{filters:g},columnCfgs:Constants.STORY_COLUMNS}}})}}}}),c.promise},_getCardBucketKey:function(a){var b=a.getRecord(),c=this._getIterationKey(b.get("Iteration")),d=b.get("Project").ObjectID,e=b.get("Feature").ObjectID;return[e,d,c].join("-")},_getIterationKey:function(a){var b="";return a&&(b=a.get?a.get("Name")+a.get("StartDate").toISOString()+a.get("EndDate").toISOString():a.Name+a.StartDate+a.EndDate),b},_isCardHidden:function(a){var b=!1,c=this._getCardBucketKey(a);return this.buckets.hasOwnProperty(c)?b=!0:this.buckets[c]=this,b},viewChange:function(){this._buildGridStore()},getModelScopedStateId:function(a,b){return this.getContext().getScopedStateId(a+"-"+b)},getHeight:function(){var a=this.getEl();if(a){var b=this.callParent(arguments);return Ext.isIE8?Math.max(b,600):b}return 0},setHeight:function(a){this.callParent(arguments),this.grid&&this.grid.setHeight(a),this.board&&this.board.setHeight(a)},getSettingsFields:function(){return[{xtype:"container"}]},searchAllProjects:function(){return this.ignoreProjectScope},onTimeboxScopeChange:function(a){this.callParent(arguments),this._onTimeboxScopeChange(a),this._update()},_onTimeboxScopeChange:function(a){a?(this.timeboxType=a.getType(),this.timebox=a.getRecord(),"release"==this.timeboxType?(this.timeboxStart=this.timebox?this.timebox.get("ReleaseStartDate"):new Date,this.timeboxEnd=this.timebox?this.timebox.get("ReleaseDate"):new Date):"milestone"==this.timeboxType?(this.timeboxStart=this.timebox?this.timebox.get("TargetDate"):new Date,this.timeboxEnd=this.timebox?this.timebox.get("TargetDate"):new Date):"iteration"==this.timeboxType&&(this.timeboxStart=this.timebox?this.timebox.get("StartDate"):new Date,this.timeboxEnd=this.timebox?this.timebox.get("EndDate"):new Date)):(this.timeboxStart=new Date,this.timeboxEnd=new Date),this._updateDateControls()},_updateDateControls:function(){var a=this.down("#start-date-picker");a.suspendEvents(),a.setValue(this.timeboxStart),a.resumeEvents();var b=this.down("#end-date-picker");b.suspendEvents(),b.setValue(this.timeboxEnd),b.resumeEvents()}});

               Rally.launchApp('release-tracking-with-filters', {
                   name: 'release-tracking-with-filters'
               });
        });
    </script>

    <style type="text/css">

.app {}

.tsinfolink {
    position: absolute;
    right: 0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.ts-page-label {
    font-weight: bold;
    font-size: medium;
}

.iteration-name {
    font-size: medium;
}

.iteration-dates {
    font-size: x-small;
    font-weight: normal;
}

.cardboard-column-header {
    margin-left: unset;
    margin-right: unset;
}

.date-label {
    font-size: larger;
    font-weight: bold;
}

.grid-area {
    background-color: rgb(244, 244, 244);
    padding: 15px;
    border: rgb(213, 213, 213);
    border-width: thin;
    border-style: solid;
    border-radius: 4px;
}

.ts-panel-header {
    background-color: rgb(244, 244, 244);
}

.ts-panel-header .x-panel-header-text {
    font-weight: bold;
}

.ts-artifact-color {
    width: 5px;
    height: 20px;
}

.ts-card-table div {
    font-weight: bold;
    font-size: 1.1em;
    color: #666;
}

.ts-scope-control {
    margin-top: 3px;
    margin-right: 9px;
}

    </style>

</head>
<body></body>
</html>